<header class="header">
  <div class="header-left">
    <button class="menu-toggle" (click)="openSidebar()" aria-label="Ouvrir le menu">â˜°</button>
    <h1>Gestion des RÃ©sidents</h1>
  </div>
  <div class="header-right">
    <app-export-pdf-button></app-export-pdf-button>
    <button class="btn-save" (click)="isAddModalOpen = true">â• Ajouter un lot</button>
  </div>
</header>

<app-toolbar
  [searchTerm]="searchTerm"
  [filterBat]="filterBat"
  [filterStatus]="filterStatus"
  (searchChange)="handleSearch($event)"
  (filterBatChange)="handleFilterBat($event)"
  (filterStatusChange)="handleFilterStatus($event)"
></app-toolbar>

<div class="table-container desktop-only">
  <table class="lot-table">
    <thead>
      <tr>
        <th class="sortable" (click)="handleSort('lotId')">
          Lot No. <span class="sort-icon">{{ getSortIcon('lotId') }}</span>
        </th>
        <th class="sortable" (click)="handleSort('batiment')">
          BÃ¢t/Appt <span class="sort-icon">{{ getSortIcon('batiment') }}</span>
        </th>
        <th>Ã‰tage</th>
        <th>Cave</th>
        <th class="sortable" (click)="handleSort('proprietaireNom')">
          PropriÃ©taire <span class="sort-icon">{{ getSortIcon('proprietaireNom') }}</span>
        </th>
        <th>Occupants</th>
        <th>Comptes Happix</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr
        app-user-row
        *ngFor="let user of users"
        [user]="user"
        [ngClass]="(user.statut_lot?.includes('Bailleur')) ? 'row-bailleur' : 'row-resident'"
        (edit)="handleEdit($event)"
        (delete)="handleDelete($event)"
        (showHistory)="handleShowHistory($event)"
      ></tr>
      <tr *ngIf="users.length === 0">
        <td colspan="8" class="empty">Aucun rÃ©sultat trouvÃ©</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="cards-container mobile-only">
  <div *ngIf="users.length === 0" class="no-results">Aucun rÃ©sultat trouvÃ©</div>
  <div *ngFor="let user of users" class="user-card" [ngClass]="(user.statut_lot?.includes('Bailleur')) ? 'row-bailleur' : 'row-resident'">
    <div class="user-card-header">
      <div>
        <h3>Lot {{ user.lot_id }}</h3>
        <span class="badge" [ngClass]="'bat-' + user.batiment">{{ user.batiment }}</span> {{ user.porte }}
      </div>
      <div class="user-card-actions">
        <button class="btn-history" (click)="handleShowHistory(user)" title="Voir l'historique">ğŸ“œ</button>
        <button class="btn-edit" (click)="handleEdit(user)">Ã‰diter</button>
        <button class="btn-delete" (click)="handleDelete(user.id)" [disabled]="!user.id">ğŸ—‘ï¸</button>
      </div>
    </div>
    <div class="user-card-body">
      <div><strong>Ã‰tage:</strong> {{ user.etage || '-' }}</div>
      <div><strong>Cave:</strong> {{ user.cave_id || '-' }}</div>
      <div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <strong>PropriÃ©taire:</strong> {{ user.proprietaire_nom || '-' }}
          <span class="chip" [ngClass]="(user.statut_lot?.includes('Bailleur')) ? 'chip-bailleur' : 'chip-resident'">
            {{ (user.statut_lot?.includes('Bailleur')) ? 'Bailleur' : 'RÃ©sident' }}
          </span>
        </div>
        <div class="subtext" *ngIf="user.proprietaire_mobile">ğŸ“ {{ user.proprietaire_mobile }}</div>
        <div class="subtext" *ngIf="user.proprietaire_email">âœ‰ï¸ {{ user.proprietaire_email }}</div>
      </div>
      <div *ngIf="user.occupants.length">
        <strong>Occupants:</strong>
        <div *ngFor="let c of user.occupants" class="subtext">ğŸ‘¤ {{ c.nom }}</div>
      </div>
      <div *ngIf="user.happix_accounts.length">
        <strong>Comptes Happix:</strong>
        <div *ngFor="let h of user.happix_accounts" class="subtext">ğŸ”‘ {{ h.nom }} - {{ h.type || '-' }}</div>
      </div>
    </div>
  </div>
</div>

<app-pagination
  [totalPages]="totalPages"
  [currentPage]="currentPage"
  (pageChange)="onPageChange($event)"
></app-pagination>

<div class="modal-overlay" *ngIf="isAddModalOpen" (click)="isAddModalOpen = false">
  <div class="modal" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="isAddModalOpen = false">âœ–</button>
    <app-add-user-form (add)="handleAddUser($event)"></app-add-user-form>
  </div>
</div>

<app-edit-modal
  *ngIf="isEditModalOpen && editingUser"
  [user]="editingUser"
  (close)="closeEditModal()"
  (save)="handleSaveEdit($event)"
></app-edit-modal>

<app-confirm-dialog
  *ngIf="confirmDialog"
  [message]="confirmDialog.message"
  [confirmText]="confirmDialog.confirmText"
  [cancelText]="confirmDialog.cancelText"
  (confirm)="confirmDialog.onConfirm()"
  (cancel)="confirmDialog = null"
></app-confirm-dialog>

<app-history-modal
  *ngIf="isHistoryModalOpen && historyApartment"
  [apartment]="historyApartment"
  (close)="closeHistoryModal()"
></app-history-modal>
